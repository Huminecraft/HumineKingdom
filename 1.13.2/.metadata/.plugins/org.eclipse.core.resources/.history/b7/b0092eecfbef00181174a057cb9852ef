package com.aymegike.huminekingdom.listener.events;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.OfflinePlayer;
import org.bukkit.Sound;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.inventory.ItemStack;

import com.aymegike.huminekingdom.HumineKingdom;
import com.aypi.utils.Timer;
import com.aypi.utils.inter.TimerFinishListener;

public class ItemDrop implements Listener {
	
	private interface Function {
		
		public void function();
		
	}
	
	@EventHandler
	public void onItemDrop(PlayerDropItemEvent e) {
		
		Player p = e.getPlayer();
		
		if(HumineKingdom.getPlayerKingdom(p) != null){
			if(e.getItemDrop().getItemStack().getType() == Material.DRAGON_EGG){
				
				if(HumineKingdom.getEggManager().getEgg().getKingdom().getName().equalsIgnoreCase(HumineKingdom.getPlayerKingdom(p).getName())){
					for(Player pls : Bukkit.getOnlinePlayers()) pls.playSound(pls.getLocation(), Sound.ENTITY_ENDER_DRAGON_GROWL, 5, 5);
				}else{
					for(OfflinePlayer op : HumineKingdom.getPlayerKingdom(p).getMembers()){
						if(op.isOnline()){
							op.getPlayer().sendMessage(ChatColor.WHITE+p.getName()+ChatColor.DARK_PURPLE+" vient de replacer l'oeuf");
							op.getPlayer().playSound(op.getPlayer().getLocation(), Sound.ENTITY_ENDER_DRAGON_GROWL, 5, 1);
						}
					}
				}
				
				timer(p, e, new Function() {
					
					@Override
					public void function() {
						HumineKingdom.getEggManager().setUpEgg(HumineKingdom.getPlayerKingdom(p), e.getItemDrop().getLocation());
						e.getItemDrop().setInvulnerable(false);
		            	e.getItemDrop().setItemStack(new ItemStack(Material.AIR));
					}
				});
			
			
			}
		} else {		
			timer(p, e, new Function() {
				
				@Override
				public void function() {
					e.getItemDrop().getLocation().getBlock().setType(Material.DRAGON_EGG);
					e.getItemDrop().setInvulnerable(false);
	            	e.getItemDrop().setItemStack(null);
				}
			});
		}
	}
	
	private void timer(Player p, PlayerDropItemEvent e, Function function) {
		e.getItemDrop().setPickupDelay(100);
		e.getItemDrop().setGlowing(true);
		e.getItemDrop().setInvulnerable(true);
		e.getItemDrop().setPortalCooldown(100);
		new Timer(Bukkit.getPluginManager().getPlugin("HumineKingdom"), 1, new TimerFinishListener() {

			@Override
			public void execute() {
				function.function();
				
			}
			
		}).start();
	}

}
